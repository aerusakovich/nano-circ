// Nextflow configuration file

params {
    // Input parameters
    base_dir = null
    simulated_data_dir = null

    // Reference files
    genome_fasta = null
    gtf_file = null
    circrna_db = null
    transcriptome = null

    // Tool paths
    isocirc_path = "/projects/dog/anastasia/progs/isoCirc"
    circnick_path = "/projects/dog/anastasia/progs/circNICK/long_read_circRNA"
    circnick_scripts = "/projects/dog/anastasia/progs/circNICK/long_read_circRNA/scripts"
    circnick_ref_path = "/projects/dog/anastasia/data/data_circNICK"

    // Containers
    cirilong_container = null
    isocirc_container = null

    // Output
    outdir = "results"

    // Parameters
    threads = 8
    species = "mouse"
    total_reads = 100000
    min_reads_per_circ = 5
    mapq_threshold = 0
    initial_tile = 1
    rescue_tile = 5

    // Tool selection
    run_cirilong = true
    run_isocirc = true
    run_circnick = true

    // Performance tracking
    track_performance = true

    // Help
    help = false
}

// Enable ANSI log for better visualization
env {
    TERM = 'xterm-256color'
}

/********************************************************************
 * DEFAULT / SLURM-nodes for each task
 ********************************************************************/

// SLURM executor configuration (default)
executor {
    name = 'slurm'
    queueSize = 50
}

// Process defaults - all use SLURM with same resources
process {
    executor = 'slurm'
    cpus = 8
    memory = '120 GB'
    time = '24h'

    // SLURM-specific options for AVX nodes
    clusterOptions = '--constraint=avx2'

    // No retries
    errorStrategy = 'terminate'
    maxRetries = 0

    // Show process output in real-time (stdout/stderr)
    echo = true
}

// Singularity settings
singularity {
    enabled = true
    autoMounts = true
    runOptions = '--writable-tmpfs'
}

// Better log format
log {
    enabled = true
    file = "${params.outdir}/pipeline_info/nextflow.log"
}

// Reports
timeline {
    enabled = true
    file = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,name,status,exit,submit,start,complete,duration,realtime,cpus,memory,rss,vmem,peak_rss,peak_vmem,time'
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_info/dag.svg"
    overwrite = true
}

/********************************************************************
 * SINGLE-NODE PROFILE: run everything on one reserved node
 ********************************************************************/

profiles {

    single_node {

        // Use local executor inside the SLURM allocation
        executor {
            name = 'local'
            // How many processes Nextflow can run concurrently
            // (tune if needed, but keep modest for 8 cores)
            queueSize = 16
        }

        process {
            executor = 'local'

            // These are "logical" resources now; they only control
            // Nextflow's internal scheduling, not SLURM.
            cpus = 8
            memory = '150 GB'
            time = '72h'

            // No SLURM options for local executor
            clusterOptions = null

            errorStrategy = 'terminate'
            maxRetries = 0
            echo = true
        }
    }
}